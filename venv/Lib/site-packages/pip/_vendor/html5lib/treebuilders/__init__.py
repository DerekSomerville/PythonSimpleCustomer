"""A collection of modules for building different kinds of trees from HTML
documents.

To create a treebuilder for a new type of tree, you need to do
implement several things:

1. A set of classes for various types of elements: Document, Doctype, Comment,
   Element. These must implement the interface of ``base.treebuilders.Node``
   (although comment nodes have a different signature for their constructor,
   see ``treebuilders.etree.Comment``) Textual content may also be implemented
   as another node type, or not, as your tree implementation requires.

2. A treebuilder object (called ``TreeBuilder`` by convention) that inherits
   from ``treebuilders.base.TreeBuilder``. This has 4 required attributes:

   * ``document_class`` - the class to use for the bottommost node of a document
   * ``element_class`` - the class to use for HTML Elements
   * ``comment_class`` - the class to use for comments
   * ``doctype_class`` - the class to use for doctypes

   It also has one required method:

   * ``get_document`` - Returns the root node of the complete document tree

3. If you wish to run the unit tests, you must also create a ``test_serializer``
   method on your treebuilder which accepts a node and returns a string
   containing Node and its children serialized according to the format used in
   the unittests

"""

from __future__ import absolute_import, division, unicode_literals

from .._utils import default_etree

tree_builder_cache = {}


def get_tree_builder(tree_type, implementation=None, **kwargs):
    """Get a TreeBuilder class for various types of trees with built-in support

    :arg tree_type: the name of the tree type required (case-insensitive). Supported
        values are:

        * "dom" - A generic builder for DOM implementations, defaulting to a
          xml.dom.minidom based implementation.
        * "etree" - A generic builder for tree implementations exposing an
          ElementTree-like interface, defaulting to xml.etree.c_element_tree if
          available and xml.etree.ElementTree if not.
        * "lxml" - A etree-based builder for lxml.etree, handling limitations
          of lxml's implementation.

    :arg implementation: (Currently applies to the "etree" and "dom" tree
        types). A module implementing the tree type e.g. xml.etree.ElementTree
        or xml.etree.c_element_tree.

    :arg kwargs: Any additional options to pass to the TreeBuilder when
        creating it.

    Example:

    >>> from html5lib.treebuilders import get_tree_builder
    >>> builder = get_tree_builder('etree')

    """

    tree_type = tree_type.lower()
    if tree_type not in tree_builder_cache:
        if tree_type == "dom":
            from . import dom
            # Come up with a sane default (pref. from the stdlib)
            if implementation is None:
                from xml.dom import minidom
                implementation = minidom
            # NEVER cache here, caching is done in the dom submodule
            return dom.get_dom_module(implementation, **kwargs).TreeBuilder
        elif tree_type == "lxml":
            from . import etree_lxml
            tree_builder_cache[tree_type] = etree_lxml.TreeBuilder
        elif tree_type == "etree":
            from . import etree
            if implementation is None:
                implementation = default_etree
            # NEVER cache here, caching is done in the etree submodule
            return etree.get_e_tree_module(implementation, **kwargs).TreeBuilder
        else:
            raise ValueError("""Unrecognised treebuilder "%s" """ % tree_type)
    return tree_builder_cache.get(tree_type)
